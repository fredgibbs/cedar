---
title: "Standardized Report Template"
subtitle: "Template demonstrating consistent parameter handling"
output:
  html_document:
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: false    
  pdf_print: paged
  pdf_document:
    fig_width: 7
date: "`r format(Sys.time(), '%d %B, %Y')`"
always_allow_html: yes
params:
  opt: 1                    # Standardized options object
  data: 1                   # Main data object (named list with components)
  report_metadata: 1        # Report generation metadata
  output_filename: 1        # Output file specification
---

```{r setup, include=FALSE}
library(kableExtra)
library(rmarkdown)
library(DT)
library(dplyr)
library(tidyr)
library(ggplot2)
library(plotly)

# Load standardization utilities
source("../includes/cone_standards.R")

# Extract parameters using standardized approach
opt <- params$opt
report_data <- params$data
metadata <- params$report_metadata
output_filename <- params$output_filename

# Validate data structure
expected_components <- c("main_analysis", "summary_stats")  # Customize per report type
validate_report_data(report_data, expected_components, "report_template")

knitr::opts_chunk$set(
  echo = FALSE, 
  warning = FALSE, 
  message = FALSE, 
  dpi = 200, 
  out.height = "40%"
)
```

# Report Summary

**Generated:** `r format(Sys.time(), '%B %d, %Y at %I:%M %p')`  
**Function:** `r metadata$function_name %||% "Unknown"`  
**Data Rows:** `r metadata$row_count %||% "Unknown"`  
**Processing Time:** `r metadata$processing_time %||% "Unknown"`

## Options Used

```{r options-table}
if (!is.null(opt)) {
  opt_df <- data.frame(
    Option = names(opt),
    Value = sapply(opt, function(x) {
      if (is.null(x)) return("NULL")
      if (length(x) > 1) return(paste(x, collapse = ", "))
      return(as.character(x))
    })
  )
  
  kable(opt_df, caption = "Analysis Options") %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
}
```

## Main Analysis

```{r main-analysis}
if (!is.null(report_data$main_analysis)) {
  if (is.data.frame(report_data$main_analysis)) {
    DT::datatable(
      report_data$main_analysis,
      options = list(
        pageLength = 15,
        scrollX = TRUE,
        dom = 'Bfrtip'
      ),
      class = 'compact'
    ) %>%
      formatRound(columns = which(sapply(report_data$main_analysis, is.numeric)), digits = 2)
  } else {
    print("Main analysis data is not in tabular format")
  }
} else {
  print("No main analysis data available")
}
```

## Summary Statistics

```{r summary-stats}
if (!is.null(report_data$summary_stats)) {
  kable(report_data$summary_stats, caption = "Summary Statistics") %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
} else {
  print("No summary statistics available")
}
```

## Visualizations

```{r plots, fig.height=6, fig.width=10}
if (!is.null(report_data$plots)) {
  for (plot_name in names(report_data$plots)) {
    cat(sprintf("\n### %s\n", tools::toTitleCase(gsub("_", " ", plot_name))))
    
    plot_obj <- report_data$plots[[plot_name]]
    if (!is.null(plot_obj)) {
      if (inherits(plot_obj, "plotly")) {
        print(plot_obj)
      } else if (inherits(plot_obj, "ggplot")) {
        print(plot_obj)
      } else {
        cat("Plot object type not recognized\n")
      }
    }
  }
} else {
  cat("No plots available\n")
}
```

## Processing Details

```{r processing-details}
if (!is.null(metadata$notes)) {
  cat("**Processing Notes:**\n")
  cat(metadata$notes)
}

if (!is.null(metadata$warnings)) {
  cat("\n\n**Warnings:**\n")
  for (warning in metadata$warnings) {
    cat(sprintf("- %s\n", warning))
  }
}

if (!is.null(metadata$errors)) {
  cat("\n\n**Errors:**\n")
  for (error in metadata$errors) {
    cat(sprintf("- %s\n", error))
  }
}
```

---
*Report generated using CEDAR standardized reporting framework*